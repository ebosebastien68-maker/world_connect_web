<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Modifier l'article - World Connect</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --text-primary: #333333;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --shadow-sm: 0 2px 10px rgba(0,0,0,0.08);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --color-danger: #ff4757;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 15px;
            box-shadow: var(--shadow-sm);
        }

        h1, h2 { text-align: center; margin-bottom: 25px; font-weight: 600; }
        h1 { font-size: 24px; }
        h2 { font-size: 20px; color: var(--text-secondary); margin-top: 40px; }

        .form-group { margin-bottom: 20px; }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .form-control {
            width: 100%; padding: 12px 15px; border: 1px solid var(--border-color);
            border-radius: 8px; font-size: 16px; background: var(--bg-primary);
            color: var(--text-primary); transition: all 0.3s ease;
        }
        .form-control:focus {
            outline: none; border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        textarea.form-control { min-height: 150px; resize: vertical; }

        .btn-submit {
            width: 100%; padding: 15px; border: none; border-radius: 8px;
            background: var(--gradient-primary); color: white; font-size: 16px;
            font-weight: bold; cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); display: flex;
            align-items: center; justify-content: center; gap: 10px;
        }
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }
        .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }
        .image-wrapper {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        .image-wrapper img {
            width: 100%; height: 120px;
            object-fit: cover; display: block;
        }
        .delete-image-btn {
            position: absolute; top: 5px; right: 5px;
            width: 28px; height: 28px;
            background: var(--color-danger); color: white;
            border: none; border-radius: 50%;
            cursor: pointer; font-size: 14px;
            display: flex; align-items: center; justify-content: center;
            opacity: 0.8; transition: all 0.3s ease;
        }
        .delete-image-btn:hover { opacity: 1; transform: scale(1.1); }
        
        #image-upload { display: none; }
        .upload-label {
            display: block; padding: 20px; border: 2px dashed var(--border-color);
            border-radius: 8px; text-align: center; cursor: pointer;
            color: var(--text-secondary); transition: all 0.3s ease;
        }
        .upload-label:hover { border-color: #667eea; background: #f0f2ff; }
        .upload-label i { font-size: 24px; margin-bottom: 10px; display: block; }
        
        #form-message {
            margin-top: 20px; padding: 12px; border-radius: 8px;
            text-align: center; display: none;
        }
        #form-message.success { background-color: #d4edda; color: #155724; }
        #form-message.error { background-color: #f8d7da; color: #721c24; }
        
        .spinner {
            width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container" id="editor-container">
        <h1><i class="fas fa-edit"></i> Modifier l'Article</h1>
        
        <form id="edit-form">
            <div class="form-group">
                <label for="texte">Contenu de l'article</label>
                <textarea id="texte" class="form-control" name="texte" required></textarea>
            </div>
            <div class="form-group">
                <label for="texte_url">Lien associé (URL)</label>
                <input type="url" id="texte_url" class="form-control" name="texte_url" placeholder="https://exemple.com">
            </div>
            <div class="form-group">
                <label for="vente_url">Lien de vente (URL)</label>
                <input type="url" id="vente_url" class="form-control" name="vente_url" placeholder="https://boutique.com/produit">
            </div>
            <div class="form-group">
                <label for="whatsapp_url">Lien WhatsApp</label>
                <input type="url" id="whatsapp_url" class="form-control" name="whatsapp_url" placeholder="https://wa.me/...">
            </div>

            <h2><i class="fas fa-images"></i> Gérer les Images</h2>
            <div class="form-group">
                <label>Images actuelles</label>
                <div class="images-grid" id="existing-images-container">
                </div>
            </div>
            <div class="form-group">
                <label for="image-upload">Ajouter de nouvelles images</label>
                <label for="image-upload" class="upload-label">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>Cliquez ici pour choisir des images</span>
                </label>
                <input type="file" id="image-upload" multiple accept="image/*">
            </div>
            <div class="form-group" id="new-images-preview-group" style="display: none;">
                <label>Aperçu des nouvelles images</label>
                <div class="images-grid" id="new-images-preview"></div>
            </div>

            <button type="submit" class="btn-submit" id="submit-btn">
                <span id="btn-text">Mettre à jour</span>
                <div class="spinner" id="btn-spinner" style="display: none;"></div>
            </button>
        </form>
        <div id="form-message"></div>
    </div>

    <script src="supabaseClient.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const form = document.getElementById('edit-form');
            const submitBtn = document.getElementById('submit-btn');
            const btnText = document.getElementById('btn-text');
            const btnSpinner = document.getElementById('btn-spinner');
            const formMessage = document.getElementById('form-message');
            const existingImagesContainer = document.getElementById('existing-images-container');
            const imageUploadInput = document.getElementById('image-upload');
            const newImagesPreviewGroup = document.getElementById('new-images-preview-group');
            const newImagesPreviewContainer = document.getElementById('new-images-preview');

            const { supabase } = window.supabaseClient;
            let newFilesToUpload = [];
            let detectedBucketName = null;

            const urlParams = new URLSearchParams(window.location.search);
            const articleId = urlParams.get('id');

            if (!articleId) {
                document.body.innerHTML = "<h1>Erreur : ID de l'article manquant.</h1>";
                return;
            }

            // Fonction pour détecter automatiquement le nom du bucket
            async function detectBucketName() {
                try {
                    const { data: buckets, error } = await supabase.storage.listBuckets();
                    if (error) throw error;
                    
                    if (buckets && buckets.length > 0) {
                        detectedBucketName = buckets[0].name;
                        console.log('Bucket détecté automatiquement:', detectedBucketName);
                        return detectedBucketName;
                    } else {
                        throw new Error('Aucun bucket trouvé dans le stockage Supabase');
                    }
                } catch (error) {
                    console.error('Erreur lors de la détection du bucket:', error);
                    return null;
                }
            }

            // Fonction pour extraire le nom du bucket depuis une URL d'image
            function extractBucketFromUrl(imageUrl) {
                try {
                    const url = new URL(imageUrl);
                    const pathParts = url.pathname.split('/');
                    const storageIndex = pathParts.indexOf('storage');
                    if (storageIndex !== -1 && pathParts.length > storageIndex + 2) {
                        return pathParts[storageIndex + 2];
                    }
                } catch (e) {
                    console.warn('Impossible d\'extraire le bucket de l\'URL:', imageUrl);
                }
                return null;
            }

            async function fetchArticleData() {
                try {
                    const { data, error } = await supabase
                        .from('articles')
                        .select('*, article_images(image_id, image_url)')
                        .eq('article_id', articleId)
                        .single();

                    if (error) throw error;
                    
                    document.getElementById('texte').value = data.texte || '';
                    document.getElementById('texte_url').value = data.texte_url || '';
                    document.getElementById('vente_url').value = data.vente_url || '';
                    document.getElementById('whatsapp_url').value = data.whatsapp_url || '';
                    
                    existingImagesContainer.innerHTML = '';
                    if (data.article_images && data.article_images.length > 0) {
                        // Détecter le bucket depuis la première image si pas encore détecté
                        if (!detectedBucketName && data.article_images[0].image_url) {
                            detectedBucketName = extractBucketFromUrl(data.article_images[0].image_url);
                            if (detectedBucketName) {
                                console.log('Bucket détecté depuis l\'URL d\'image:', detectedBucketName);
                            }
                        }

                        data.article_images.forEach(img => {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'image-wrapper';
                            wrapper.id = `image-${img.image_id}`;
                            wrapper.innerHTML = `
                                <img src="${img.image_url}" alt="Image de l'article">
                                <button type="button" class="delete-image-btn" title="Supprimer l'image">
                                    <i class="fas fa-trash"></i>
                                </button>
                            `;
                            existingImagesContainer.appendChild(wrapper);

                            wrapper.querySelector('.delete-image-btn').addEventListener('click', () => {
                                handleDeleteImage(img.image_id, img.image_url);
                            });
                        });
                    } else {
                        existingImagesContainer.innerHTML = '<p style="color: var(--text-secondary);">Aucune image pour cet article.</p>';
                    }

                } catch (error) {
                    console.error("Erreur de chargement de l'article:", error);
                    document.body.innerHTML = `<h1>Erreur: Impossible de charger l'article.</h1>`;
                }
            }
            
            async function handleDeleteImage(imageId, imageUrl) {
                if (!confirm("Êtes-vous sûr de vouloir supprimer cette image définitivement ?")) return;

                try {
                    const { error: dbError } = await supabase
                        .from('article_images')
                        .delete()
                        .eq('image_id', imageId);
                    if (dbError) throw dbError;

                    // Utiliser le bucket détecté
                    const bucketToUse = detectedBucketName || await detectBucketName();
                    if (!bucketToUse) {
                        console.warn("Impossible de déterminer le bucket, suppression du stockage ignorée");
                    } else {
                        const imagePath = new URL(imageUrl).pathname.split(`/${bucketToUse}/`)[1];
                        const { error: storageError } = await supabase.storage
                            .from(bucketToUse)
                            .remove([imagePath]);
                        if (storageError) console.warn("Avertissement lors de la suppression du stockage:", storageError);
                    }

                    document.getElementById(`image-${imageId}`).remove();
                    alert("Image supprimée avec succès !");

                } catch (error) {
                    console.error("Erreur de suppression d'image:", error);
                    alert("Une erreur s'est produite lors de la suppression.");
                }
            }

            imageUploadInput.addEventListener('change', (event) => {
                newFilesToUpload = Array.from(event.target.files);
                newImagesPreviewContainer.innerHTML = '';

                if (newFilesToUpload.length > 0) {
                    newImagesPreviewGroup.style.display = 'block';
                    newFilesToUpload.forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const wrapper = document.createElement('div');
                            wrapper.className = 'image-wrapper';
                            wrapper.innerHTML = `<img src="${e.target.result}" alt="Aperçu">`;
                            newImagesPreviewContainer.appendChild(wrapper);
                        };
                        reader.readAsDataURL(file);
                    });
                } else {
                    newImagesPreviewGroup.style.display = 'none';
                }
            });

            form.addEventListener('submit', async (event) => {
                event.preventDefault();

                submitBtn.disabled = true;
                btnText.textContent = 'Mise à jour...';
                btnSpinner.style.display = 'block';
                formMessage.style.display = 'none';

                try {
                    const updatedArticleData = {
                        texte: document.getElementById('texte').value,
                        texte_url: document.getElementById('texte_url').value || null,
                        vente_url: document.getElementById('vente_url').value || null,
                        whatsapp_url: document.getElementById('whatsapp_url').value || null,
                    };
                    const { error: updateError } = await supabase.from('articles').update(updatedArticleData).eq('article_id', articleId);
                    if (updateError) throw updateError;

                    if (newFilesToUpload.length > 0) {
                        // S'assurer qu'on a détecté le bucket
                        const bucketToUse = detectedBucketName || await detectBucketName();
                        if (!bucketToUse) {
                            throw new Error('Impossible de déterminer le bucket de stockage');
                        }

                        const uploadPromises = newFilesToUpload.map(file => {
                            const filePath = `public/${Date.now()}-${file.name}`;
                            return supabase.storage.from(bucketToUse).upload(filePath, file);
                        });
                        
                        const uploadResults = await Promise.all(uploadPromises);

                        const newImageRecords = [];
                        for (const result of uploadResults) {
                            if (result.error) throw result.error;
                            const { data: urlData } = supabase.storage.from(bucketToUse).getPublicUrl(result.data.path);
                            newImageRecords.push({
                                article_id: articleId,
                                image_url: urlData.publicUrl
                            });
                        }

                        if (newImageRecords.length > 0) {
                            const { error: insertError } = await supabase.from('article_images').insert(newImageRecords);
                            if (insertError) throw insertError;
                        }
                    }

                    formMessage.textContent = '✅ Article mis à jour avec succès !';
                    formMessage.className = 'success';
                    formMessage.style.display = 'block';

                    setTimeout(() => { window.location.href = 'index.html'; }, 2000);

                } catch (error) {
                    console.error("Erreur de mise à jour:", error);
                    formMessage.textContent = `❌ Erreur : ${error.message}`;
                    formMessage.className = 'error';
                    formMessage.style.display = 'block';
                    submitBtn.disabled = false;
                    btnText.textContent = 'Mettre à jour';
                    btnSpinner.style.display = 'none';
                }
            });

            // Détecter le bucket au chargement
            await detectBucketName();
            await fetchArticleData();
        });
    </script>
</body>
</html>
