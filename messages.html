<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; height: 100vh; overflow: hidden; }
        
        .messages-wrapper { height: 100vh; display: flex; flex-direction: column; }
        
        /* Header */
        .messages-header { background: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; z-index: 100; }
        .messages-header h1 { color: #333; font-size: 20px; display: flex; align-items: center; gap: 10px; }
        .messages-header h1 i { color: #667eea; }
        
        .header-actions { display: flex; gap: 10px; }
        .action-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: transform 0.2s; font-size: 14px; }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); }
        .action-btn.secondary { background: #f0f0f0; color: #667eea; }
        
        /* Container principal */
        .messages-container { flex: 1; overflow: hidden; background: white; margin: 15px; border-radius: 15px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); display: flex; flex-direction: column; position: relative; }
        
        /* Zone de chat principale */
        .chat-area { flex: 1; display: flex; flex-direction: column; }
        
        .chat-header { padding: 15px 20px; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; gap: 12px; background: #fafbfc; }
        .chat-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; flex-shrink: 0; }
        .chat-user-info { flex: 1; }
        .chat-user-info h3 { color: #333; font-size: 15px; margin-bottom: 2px; }
        .chat-user-info p { color: #999; font-size: 12px; }
        
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; background: #f5f7fa; }
        .message-bubble { max-width: 75%; padding: 12px 16px; border-radius: 18px; word-wrap: break-word; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .message-sent { align-self: flex-end; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-bottom-right-radius: 4px; }
        .message-received { align-self: flex-start; background: white; color: #333; border-bottom-left-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .message-text { margin-bottom: 5px; line-height: 1.4; font-size: 14px; }
        .message-time { font-size: 10px; opacity: 0.7; }
        .message-image { max-width: 100%; max-height: 250px; border-radius: 12px; margin-top: 8px; cursor: pointer; }
        
        .chat-input-area { padding: 15px 20px; border-top: 1px solid #e0e0e0; display: flex; gap: 10px; align-items: center; background: white; }
        .attach-btn { background: #f0f0f0; border: none; color: #667eea; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; cursor: pointer; transition: all 0.3s; flex-shrink: 0; }
        .attach-btn:hover { background: #e0e0e0; }
        .message-input { flex: 1; padding: 10px 18px; border: 2px solid #e0e0e0; border-radius: 25px; font-size: 14px; font-family: inherit; }
        .message-input:focus { outline: none; border-color: #667eea; }
        .send-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 16px; flex-shrink: 0; }
        .send-btn:hover { transform: scale(1.1); }
        
        .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; background: #f5f7fa; }
        .empty-state i { font-size: 60px; margin-bottom: 15px; color: #ddd; }
        .empty-state h3 { font-size: 16px; color: #666; margin-bottom: 8px; }
        .empty-state p { font-size: 13px; }
        
        /* Modal conversations/contacts */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 20px; width: 95%; max-width: 450px; max-height: 85vh; overflow: hidden; display: flex; flex-direction: column; animation: modalSlide 0.3s ease; }
        @keyframes modalSlide { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .modal-header { padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .modal-header h3 { font-size: 18px; display: flex; align-items: center; gap: 10px; }
        .close-modal { background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 20px; color: white; cursor: pointer; }
        .close-modal:hover { background: rgba(255,255,255,0.3); }
        
        .modal-search { padding: 15px; border-bottom: 1px solid #e0e0e0; }
        .modal-search input { width: 100%; padding: 10px 15px 10px 40px; border: 2px solid #e0e0e0; border-radius: 20px; font-size: 14px; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23999" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>') no-repeat 12px center; }
        .modal-search input:focus { outline: none; border-color: #667eea; }
        
        .list-container { flex: 1; overflow-y: auto; }
        .list-item { padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.2s; }
        .list-item:hover { background: #f8f9ff; }
        .list-item.active { background: #f0f0ff; border-left: 3px solid #667eea; }
        
        .item-avatar { width: 45px; height: 45px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px; flex-shrink: 0; }
        .item-info { flex: 1; min-width: 0; }
        .item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .item-name { font-weight: 600; color: #333; font-size: 14px; }
        .item-role { font-size: 10px; color: #667eea; background: #f0f0ff; padding: 2px 6px; border-radius: 8px; }
        .item-time { font-size: 11px; color: #999; }
        .item-preview { font-size: 12px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-unread { background: #667eea; color: white; border-radius: 10px; padding: 2px 7px; font-size: 10px; font-weight: bold; flex-shrink: 0; }
        
        .loading { text-align: center; padding: 30px; color: #999; }
        .loading i { font-size: 30px; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="messages-wrapper">
        <div class="messages-header">
            <h1><i class="fas fa-comments"></i> <span id="header-title">Messagerie</span></h1>
            <div class="header-actions">
                <button class="action-btn secondary" onclick="openConversationsModal()">
                    <i class="fas fa-list"></i>
                    <span>Conversations</span>
                </button>
                <button class="action-btn" onclick="openContactsModal()">
                    <i class="fas fa-user-plus"></i>
                    <span id="contacts-btn-text">Contacts</span>
                </button>
            </div>
        </div>

        <div class="messages-container">
            <div class="chat-area" id="chat-area">
                <div class="empty-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <h3>Chargement...</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Conversations -->
    <div class="modal" id="conversations-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-comments"></i> Conversations récentes</h3>
                <button class="close-modal" onclick="closeConversationsModal()">×</button>
            </div>
            <div class="modal-search">
                <input type="text" placeholder="Rechercher..." id="search-conversations">
            </div>
            <div class="list-container" id="conversations-list"></div>
        </div>
    </div>

    <!-- Modal Contacts -->
    <div class="modal" id="contacts-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-address-book"></i> <span id="contacts-modal-title">Contacts</span></h3>
                <button class="close-modal" onclick="closeContactsModal()">×</button>
            </div>
            <div class="modal-search">
                <input type="text" placeholder="Rechercher..." id="search-contacts">
            </div>
            <div class="list-container" id="contacts-list"></div>
        </div>
    </div>

    <script src="supabaseClient.js"></script>
    <script>
        const { supabase, getCurrentUser, getUserProfile } = window.supabaseClient;
        let currentUser = null;
        let userProfile = null;
        let currentChatUser = null;
        let messageSubscription = null;
        let conversationsCache = [];
        let contactsCache = [];

        window.addEventListener('DOMContentLoaded', async () => {
            currentUser = await getCurrentUser();
            if (!currentUser) {
                window.location.href = 'connexion.html';
                return;
            }

            userProfile = await getUserProfile(currentUser.id);
            await initInterface();

            document.getElementById('search-conversations').addEventListener('input', (e) => filterList('conversations', e.target.value));
            document.getElementById('search-contacts').addEventListener('input', (e) => filterList('contacts', e.target.value));
        });

        async function initInterface() {
            if (userProfile.role === 'user') {
                document.getElementById('contacts-btn-text').textContent = 'Admins';
                document.getElementById('contacts-modal-title').textContent = 'Administrateurs';
                await initUserChat();
            } else {
                document.getElementById('contacts-btn-text').textContent = 'Contacts';
                document.getElementById('contacts-modal-title').textContent = 'Tous les contacts';
                await initAdminChat();
            }
        }

        // ===== USER =====
        async function initUserChat() {
            const storedAdminId = localStorage.getItem(`default_admin_${currentUser.id}`);
            let defaultAdmin = null;

            if (storedAdminId) {
                const { data } = await supabase
                    .from('users_profile')
                    .select('*')
                    .eq('user_id', storedAdminId)
                    .eq('role', 'admin')
                    .single();
                defaultAdmin = data;
            }

            if (!defaultAdmin) {
                const { data: admins } = await supabase
                    .from('users_profile')
                    .select('user_id, prenom, nom, role')
                    .eq('role', 'admin')
                    .limit(10);

                if (admins && admins.length > 0) {
                    defaultAdmin = admins[Math.floor(Math.random() * admins.length)];
                    localStorage.setItem(`default_admin_${currentUser.id}`, defaultAdmin.user_id);
                }
            }

            if (defaultAdmin) {
                openChat(defaultAdmin);
            } else {
                showEmptyState('Aucun administrateur disponible');
            }

            await loadConversations();
        }

        // ===== ADMIN =====
        async function initAdminChat() {
            await loadConversations();
            
            if (conversationsCache.length > 0) {
                openChat(conversationsCache[0].user);
            } else {
                showEmptyState('Aucune conversation', 'Attendez qu\'un utilisateur vous contacte');
            }
        }

        // ===== CONVERSATIONS =====
        async function loadConversations() {
            try {
                const { data: messages, error } = await supabase
                    .from('messages')
                    .select('message_id, sender_id, receiver_id, texte, date_created, read_status')
                    .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
                    .order('date_created', { ascending: false })
                    .limit(100);

                if (error) throw error;

                const userIds = new Set();
                messages.forEach(msg => {
                    const otherId = msg.sender_id === currentUser.id ? msg.receiver_id : msg.sender_id;
                    userIds.add(otherId);
                });

                if (userIds.size === 0) {
                    conversationsCache = [];
                    return;
                }

                const { data: users, error: usersError } = await supabase
                    .from('users_profile')
                    .select('user_id, prenom, nom, role')
                    .in('user_id', Array.from(userIds));

                if (usersError) throw usersError;

                const usersMap = {};
                users.forEach(u => { usersMap[u.user_id] = u; });

                const conversations = {};
                messages.forEach(msg => {
                    const otherId = msg.sender_id === currentUser.id ? msg.receiver_id : msg.sender_id;
                    const otherUser = usersMap[otherId];

                    if (!otherUser) return;
                    if (userProfile.role === 'user' && otherUser.role !== 'admin') return;

                    if (!conversations[otherId]) {
                        conversations[otherId] = {
                            user: otherUser,
                            lastMessage: msg,
                            unread: 0
                        };
                    }
                    if (msg.receiver_id === currentUser.id && !msg.read_status) {
                        conversations[otherId].unread++;
                    }
                });

                conversationsCache = Object.values(conversations).sort((a, b) =>
                    new Date(b.lastMessage.date_created) - new Date(a.lastMessage.date_created)
                );

            } catch (error) {
                console.error('Erreur:', error);
                conversationsCache = [];
            }
        }

        function openConversationsModal() {
            displayConversations(conversationsCache);
            document.getElementById('conversations-modal').classList.add('show');
        }

        function closeConversationsModal() {
            document.getElementById('conversations-modal').classList.remove('show');
        }

        function displayConversations(conversations) {
            const container = document.getElementById('conversations-list');

            if (conversations.length === 0) {
                container.innerHTML = '<div class="loading"><p>Aucune conversation</p></div>';
                return;
            }

            container.innerHTML = '';
            conversations.forEach(conv => {
                const initials = `${conv.user.prenom[0]}${conv.user.nom[0]}`.toUpperCase();
                const lastMsg = conv.lastMessage.texte?.substring(0, 40) || '📷 Image';
                const time = formatTime(conv.lastMessage.date_created);

                const div = document.createElement('div');
                div.className = 'list-item';
                if (currentChatUser && currentChatUser.user_id === conv.user.user_id) {
                    div.classList.add('active');
                }
                div.onclick = () => {
                    closeConversationsModal();
                    openChat(conv.user);
                };
                div.innerHTML = `
                    <div class="item-avatar">${initials}</div>
                    <div class="item-info">
                        <div class="item-header">
                            <span class="item-name">${conv.user.prenom} ${conv.user.nom}</span>
                            ${conv.user.role === 'admin' ? '<span class="item-role">Admin</span>' : ''}
                            <span class="item-time">${time}</span>
                        </div>
                        <div class="item-preview">${lastMsg}</div>
                    </div>
                    ${conv.unread > 0 ? `<div class="item-unread">${conv.unread}</div>` : ''}
                `;
                container.appendChild(div);
            });
        }

        // ===== CONTACTS =====
        async function loadContacts() {
            try {
                const role = userProfile.role === 'user' ? 'admin' : null;
                let query = supabase
                    .from('users_profile')
                    .select('user_id, prenom, nom, role')
                    .neq('user_id', currentUser.id)
                    .order('prenom')
                    .limit(50);

                if (role) {
                    query = query.eq('role', role);
                }

                const { data, error } = await query;
                if (error) throw error;
                contactsCache = data || [];
            } catch (error) {
                console.error('Erreur:', error);
                contactsCache = [];
            }
        }

        function openContactsModal() {
            if (contactsCache.length === 0) {
                document.getElementById('contacts-list').innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i><p>Chargement...</p></div>';
                document.getElementById('contacts-modal').classList.add('show');
                loadContacts().then(() => displayContacts(contactsCache));
            } else {
                displayContacts(contactsCache);
                document.getElementById('contacts-modal').classList.add('show');
            }
        }

        function closeContactsModal() {
            document.getElementById('contacts-modal').classList.remove('show');
        }

        function displayContacts(contacts) {
            const container = document.getElementById('contacts-list');

            if (contacts.length === 0) {
                container.innerHTML = '<div class="loading"><p>Aucun contact</p></div>';
                return;
            }

            container.innerHTML = '';
            contacts.forEach(user => {
                const initials = `${user.prenom[0]}${user.nom[0]}`.toUpperCase();
                const div = document.createElement('div');
                div.className = 'list-item';
                div.onclick = () => {
                    closeContactsModal();
                    openChat(user);
                };
                div.innerHTML = `
                    <div class="item-avatar">${initials}</div>
                    <div class="item-info">
                        <div class="item-header">
                            <span class="item-name">${user.prenom} ${user.nom}</span>
                            ${user.role === 'admin' ? '<span class="item-role">Admin</span>' : ''}
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function filterList(type, query) {
            const data = type === 'conversations' ? conversationsCache : contactsCache;
            const filtered = data.filter(item => {
                const user = item.user || item;
                return `${user.prenom} ${user.nom}`.toLowerCase().includes(query.toLowerCase());
            });

            if (type === 'conversations') {
                displayConversations(filtered);
            } else {
                displayContacts(filtered);
            }
        }

        // ===== CHAT =====
        function openChat(user) {
            currentChatUser = user;
            const initials = `${user.prenom[0]}${user.nom[0]}`.toUpperCase();
            const chatArea = document.getElementById('chat-area');

            chatArea.innerHTML = `
                <div class="chat-header">
                    <div class="chat-avatar">${initials}</div>
                    <div class="chat-user-info">
                        <h3>${user.prenom} ${user.nom}</h3>
                        <p>${user.role === 'admin' ? 'Administrateur' : 'Utilisateur'}</p>
                    </div>
                </div>
                <div class="chat-messages" id="chat-messages"></div>
                <div class="chat-input-area">
                    <input type="file" id="image-input" accept="image/*" style="display: none;" onchange="handleImageSelect(event)">
                    <button class="attach-btn" onclick="document.getElementById('image-input').click()">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <input type="text" class="message-input" id="message-input" placeholder="Votre message..." onkeypress="handleKeyPress(event)" autocomplete="off">
                    <button class="send-btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            `;

            loadMessages(user.user_id);
            markMessagesAsRead(user.user_id);
            subscribeToMessages(user.user_id);
            document.getElementById('message-input').focus();
        }

        async function loadMessages(otherUserId) {
            try {
                const { data, error } = await supabase
                    .from('messages')
                    .select('message_id, sender_id, texte, image_url, date_created')
                    .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${otherUserId}),and(sender_id.eq.${otherUserId},receiver_id.eq.${currentUser.id})`)
                    .order('date_created', { ascending: true })
                    .limit(100);

                if (error) throw error;
                displayMessages(data);
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        function displayMessages(messages) {
            const container = document.getElementById('chat-messages');
            if (!container) return;

            const shouldScroll = container.scrollHeight - container.scrollTop <= container.clientHeight + 100;
            container.innerHTML = '';

            messages.forEach(msg => {
                const isSent = msg.sender_id === currentUser.id;
                const div = document.createElement('div');
                div.className = `message-bubble ${isSent ? 'message-sent' : 'message-received'}`;

                let content = '';
                if (msg.texte) content += `<div class="message-text">${escapeHtml(msg.texte)}</div>`;
                if (msg.image_url) content += `<img src="${msg.image_url}" class="message-image" onclick="window.open('${msg.image_url}', '_blank')">`;
                content += `<div class="message-time">${formatTime(msg.date_created)}</div>`;

                div.innerHTML = content;
                container.appendChild(div);
            });

            if (shouldScroll) container.scrollTop = container.scrollHeight;
        }

        async function sendMessage(imageFile = null) {
            const input = document.getElementById('message-input');
            const texte = input ? input.value.trim() : '';

            if (!texte && !imageFile) return;

            try {
                let imageUrl = null;
                if (imageFile) {
                    const fileName = `${Date.now()}_${imageFile.name}`;
                    const { error: uploadError } = await supabase.storage
                        .from('messages-images')
                        .upload(fileName, imageFile);

                    if (uploadError) throw uploadError;
                    const { data } = supabase.storage.from('messages-images').getPublicUrl(fileName);
                    imageUrl = data.publicUrl;
                }

                await supabase.from('messages').insert({
                    sender_id: currentUser.id,
                    receiver_id: currentChatUser.user_id,
                    texte: texte || null,
                    image_url: imageUrl
                });

                if (input) input.value = '';
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        async function markMessagesAsRead(otherUserId) {
            try {
                await supabase
                    .from('messages')
                    .update({ read_status: true })
                    .eq('sender_id', otherUserId)
                    .eq('receiver_id', currentUser.id);
                loadConversations();
            } catch (error) {
                console.error('Erreur:', error);
            }
        }

        function subscribeToMessages(otherUserId) {
            if (messageSubscription) supabase.removeChannel(messageSubscription);

            messageSubscription = supabase.channel(`chat-${currentUser.id}-${otherUserId}`)
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages'
                }, (payload) => {
                    if ((payload.new.sender_id === otherUserId && payload.new.receiver_id === currentUser.id) ||
                        (payload.new.sender_id === currentUser.id && payload.new.receiver_id === otherUserId)) {
                        loadMessages(otherUserId);
                        loadConversations();
                    }
                })
                .subscribe();
        }

        // ===== UTILITAIRES =====
        function showEmptyState(title, subtitle = '') {
            document.getElementById('chat-area').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <h3>${title}</h3>
                    ${subtitle ? `<p>${subtitle}</p>` : ''}
                </div>
            `;
        }

        function formatTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'À l\'instant';
            if (diff < 3600000) return `${Math.floor(diff / 60000)}min`;
            if (date.toDateString() === now.toDateString()) {
                return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            }
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        }

        function handleImageSelect(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 5000000) {
                    alert('L\'image est trop volumineuse (max 5MB)');
                    return;
                }
                sendMessage(file);
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Fermeture des modals au clic à l'extérieur
        document.getElementById('conversations-modal').addEventListener('click', function(e) {
            if (e.target === this) closeConversationsModal();
        });

        document.getElementById('contacts-modal').addEventListener('click', function(e) {
            if (e.target === this) closeContactsModal();
        });

        // Nettoyage à la fermeture
        window.addEventListener('beforeunload', () => {
            if (messageSubscription) supabase.removeChannel(messageSubscription);
        });
    </script>
</body>
</html>
